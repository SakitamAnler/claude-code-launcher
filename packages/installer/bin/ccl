#!/usr/bin/env node

const { spawn, execSync } = require('child_process');
const process = require('process');
const path = require('path');

// 根据平台和架构确定要执行的命令
function getTargetCommand() {
  const platform = process.platform;
  const arch = process.arch;

  switch (`${platform}-${arch}`) {
    case 'darwin-arm64':
      return 'ccl-darwin-arm64';
    case 'darwin-x64':
      return 'ccl-darwin-x64';
    case 'linux-x64':
      return 'ccl-linux-x64';
    case 'win32-x64': {
      // Windows 下直接使用 ccl.exe
      // 获取 npm 全局 node_modules 路径
      try {
        const npmRoot = execSync('npm root -g', { encoding: 'utf-8' }).trim();
        const pkgPath = path.join(npmRoot, 'sakitamanler-ccl-win32');
        const exePath = path.join(pkgPath, 'ccl.exe');
        return exePath;
      } catch (error) {
        throw new Error('Failed to locate npm global directory. Please ensure npm is properly installed.');
      }
    }
    default:
      throw new Error(`Unsupported platform: ${platform}-${arch}`);
  }
}

// 错误处理函数
function handleError(error, command = '') {
  if (error.code === 'ENOENT') {
    console.error(`Command '${command}' not found. Please run 'npm install -g sakitamanler-ccl-launcher' to install the required components.`);
  } else {
    console.error('Error executing command:', error.message);
  }

  // Windows 下的特殊错误处理
  if (process.platform === 'win32') {
    if (error.code === 'EPERM') {
      console.error('Permission denied. Try running as administrator.');
    }
  } else {
    if (error.code === 'EACCES') {
      console.error('Permission denied. Try using sudo.');
    }
  }

  process.exit(1);
}

// 执行目标命令
function executeTargetCommand() {
  try {
    const command = getTargetCommand();
    const args = process.argv.slice(2);

    let child;
    // Windows 平台特殊处理
    if (process.platform === 'win32') {
      // Windows 下直接执行 ccl.exe
      child = spawn(command, args, {
        stdio: 'inherit',
        shell: false
      });
    } else {
      child = spawn(command, args, {
        stdio: 'inherit',
        shell: false
      });
    }

    // 统一信号处理
    process.on('SIGINT', () => {
      if (process.platform === 'win32') {
        child.kill(); // Windows 下直接 kill
      } else {
        child.kill('SIGINT'); // Unix-like 系统发送 SIGINT
      }
    });

    child.on('close', (code) => {
      process.exit(code);
    });

    child.on('error', (error) => {
      handleError(error, command);
    });
  } catch (error) {
    handleError(error);
  }
}

executeTargetCommand();
